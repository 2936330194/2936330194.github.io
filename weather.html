<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open-Meteo æ°”è±¡æ•°æ®çœ‹æ¿</title>
    <!-- Tailwind CSS ç”¨äºæ ·å¼ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js ç”¨äºå›¾è¡¨ç»˜åˆ¶ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome å›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <a href="index.html" class="text-gray-500 hover:text-blue-600 transition flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> è¿”å›ä¸»é¡µ
            </a>
            <span class="font-semibold text-gray-700">æˆ‘çš„æ•°æ®ç§‘å­¦é¡¹ç›®</span>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4 py-8">
        <!-- å¤´éƒ¨æ ‡é¢˜ -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-blue-600 mb-2"><i class="fas fa-cloud-sun-rain mr-2"></i>æ ¼ç‚¹æ°”è±¡é¢„æµ‹çœ‹æ¿</h1>
            <p class="text-gray-500">åŸºäº Open-Meteo æ•°æ®æºï¼Œæä¾›æœªæ¥24å°æ—¶ç²¾å‡†é¢„æµ‹</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- å·¦ä¾§ï¼šæ§åˆ¶é¢æ¿ -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md h-fit">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">å‚æ•°é…ç½®</h2>
                
                <!-- åæ ‡è¾“å…¥ -->
                <div class="mb-6 space-y-3">
                    <h3 class="font-medium text-gray-700">ğŸ“ åœ°ç†ä½ç½®</h3>
                    <div>
                        <label class="block text-sm text-gray-500 mb-1">çº¬åº¦ (Latitude)</label>
                        <input type="number" id="input-lat" value="30.5461" step="0.0001" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-500 mb-1">ç»åº¦ (Longitude)</label>
                        <input type="number" id="input-lon" value="114.3562" step="0.0001" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button onclick="useCurrentLocation()" class="text-xs text-blue-500 hover:text-blue-700 underline mt-1">
                        <i class="fas fa-location-arrow"></i> ä½¿ç”¨å½“å‰ä½ç½®
                    </button>
                </div>

                <!-- æ°”è±¡å‚æ•°é€‰æ‹© -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-medium text-gray-700">ğŸ“Š å±•ç¤ºå‚æ•°</h3>
                        <div class="text-xs space-x-2">
                            <button onclick="toggleAll(true)" class="text-blue-500 hover:underline">å…¨é€‰</button>
                            <button onclick="toggleAll(false)" class="text-gray-500 hover:underline">æ¸…ç©º</button>
                        </div>
                    </div>
                    
                    <div id="checkbox-container" class="space-y-2 max-h-64 overflow-y-auto pr-2 text-sm">
                        <!-- å¤é€‰æ¡†å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- æäº¤æŒ‰é’® -->
                <button onclick="fetchData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-200 flex items-center justify-center">
                    <span id="btn-text">ç”Ÿæˆå›¾è¡¨</span>
                    <i id="btn-spinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                </button>
            </div>

            <!-- å³ä¾§ï¼šå›¾è¡¨å±•ç¤ºåŒºåŸŸ -->
            <div class="lg:col-span-3 space-y-6">
                <!-- ä¸»è¦å›¾è¡¨å®¹å™¨ -->
                <div class="bg-white p-6 rounded-xl shadow-md min-h-[400px]">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">è¶‹åŠ¿å›¾è¡¨</h2>
                        <span id="update-time" class="text-sm text-gray-400"></span>
                    </div>
                    <div class="relative h-96 w-full">
                        <canvas id="weatherChart"></canvas>
                    </div>
                </div>

                <!-- æ•°æ®è¡¨æ ¼é¢„è§ˆ (å¯é€‰) -->
                <div class="bg-white p-6 rounded-xl shadow-md overflow-hidden">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">æ•°æ®æ¦‚è§ˆ (å‰5å°æ—¶)</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50" id="table-head">
                                <!-- è¡¨å¤´åŠ¨æ€ç”Ÿæˆ -->
                            </thead>
                            <tbody id="table-body">
                                <!-- è¡¨æ ¼å†…å®¹åŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è„šæœ¬é€»è¾‘ -->
    <script>
        // --- 1. é…ç½®ä¸å®šä¹‰ ---
        
        // å®šä¹‰æ°”è±¡å˜é‡åŠå…¶å…ƒæ•°æ® (å¯¹åº” Python æ¨¡å—ä¸­çš„ HOURLY_VARIABLES)
        const WEATHER_PARAMS = [
            { id: "temperature_2m", label: "2ç±³æ°”æ¸©", unit: "Â°C", color: "#ef4444", default: true },
            { id: "relative_humidity_2m", label: "ç›¸å¯¹æ¹¿åº¦", unit: "%", color: "#3b82f6", default: true },
            { id: "dew_point_2m", label: "éœ²ç‚¹æ¸©åº¦", unit: "Â°C", color: "#6366f1", default: false },
            { id: "apparent_temperature", label: "ä½“æ„Ÿæ¸©åº¦", unit: "Â°C", color: "#f97316", default: false },
            { id: "surface_pressure", label: "åœ°é¢æ°”å‹", unit: "hPa", color: "#8b5cf6", default: false },
            { id: "cloud_cover", label: "æ€»äº‘é‡", unit: "%", color: "#64748b", default: false },
            { id: "wind_speed_10m", label: "10ç±³é£é€Ÿ", unit: "m/s", color: "#10b981", default: true },
            { id: "direct_radiation", label: "ç›´æ¥è¾å°„", unit: "W/mÂ²", color: "#eab308", default: false },
            { id: "diffuse_radiation", label: "æ•£å°„è¾å°„", unit: "W/mÂ²", color: "#d97706", default: false },
        ];

        let chartInstance = null;

        // --- 2. åˆå§‹åŒ–é¡µé¢ ---
        
        window.onload = function() {
            initCheckboxes();
            // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–ä¸€æ¬¡é»˜è®¤æ•°æ®
            fetchData();
        };

        function initCheckboxes() {
            const container = document.getElementById('checkbox-container');
            container.innerHTML = '';
            
            WEATHER_PARAMS.forEach(param => {
                const div = document.createElement('div');
                div.className = "flex items-center";
                div.innerHTML = `
                    <input type="checkbox" id="cb-${param.id}" value="${param.id}" 
                           class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                           ${param.default ? 'checked' : ''}>
                    <label for="cb-${param.id}" class="ml-2 text-gray-700 truncate cursor-pointer select-none flex-1">
                        ${param.label} <span class="text-xs text-gray-400">(${param.unit})</span>
                    </label>
                `;
                container.appendChild(div);
            });
        }

        // --- 3. æ ¸å¿ƒé€»è¾‘ï¼šè·å–æ•°æ® ---

        async function fetchData() {
            const lat = document.getElementById('input-lat').value;
            const lon = document.getElementById('input-lon').value;
            
            // è·å–é€‰ä¸­çš„å‚æ•°
            const selectedParams = WEATHER_PARAMS.filter(p => document.getElementById(`cb-${p.id}`).checked);
            
            if (selectedParams.length === 0) {
                alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ°”è±¡å‚æ•°ï¼");
                return;
            }

            const variables = selectedParams.map(p => p.id).join(',');
            
            // UI åŠ è½½çŠ¶æ€
            setLoading(true);

            // æ„å»º API URL (å®Œå…¨å¤åˆ» Python æ¨¡å—çš„é€»è¾‘)
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=${variables}&models=ecmwf_ifs&timezone=Asia%2FShanghai&wind_speed_unit=ms&forecast_days=1`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥");
                
                const data = await response.json();
                renderChart(data.hourly, selectedParams);
                renderTable(data.hourly, selectedParams);
                
                document.getElementById('update-time').innerText = `æ›´æ–°æ—¶é—´: ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                console.error(error);
                alert("è·å–æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åæ ‡è¾“å…¥ã€‚");
            } finally {
                setLoading(false);
            }
        }

        // --- 4. æ¸²æŸ“å›¾è¡¨ ---

        function renderChart(hourlyData, selectedParams) {
            const ctx = document.getElementById('weatherChart').getContext('2d');
            
            // æå–æ—¶é—´è½´ (æ ¼å¼åŒ–ä¸ºå°æ—¶)
            const labels = hourlyData.time.map(t => t.split('T')[1]);

            // æ„å»ºæ•°æ®é›†
            const datasets = selectedParams.map(param => {
                return {
                    label: `${param.label} (${param.unit})`,
                    data: hourlyData[param.id],
                    borderColor: param.color,
                    backgroundColor: param.color + '20', // æ·»åŠ é€æ˜åº¦
                    borderWidth: 2,
                    tension: 0.3, // æ›²çº¿å¹³æ»‘åº¦
                    pointRadius: 2,
                    yAxisID: param.unit === '%' ? 'y-percent' : 'y-default' // ç®€å•çš„åŒè½´å¤„ç†
                };
            });

            // å¦‚æœå·²æœ‰å›¾è¡¨ï¼Œé”€æ¯é‡å»º
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#333',
                            bodyColor: '#333',
                            borderColor: '#ddd',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false }
                        },
                        'y-default': {
                            type: 'linear',
                            display: true,
                            position: 'left',
                        },
                        'y-percent': {
                            type: 'linear',
                            display: datasets.some(d => d.yAxisID === 'y-percent'),
                            position: 'right',
                            min: 0,
                            max: 100,
                            grid: { display: false } // å³ä¾§è½´ä¸æ˜¾ç¤ºç½‘æ ¼çº¿
                        }
                    }
                }
            });
        }

        // --- 5. æ¸²æŸ“è¡¨æ ¼ (ä»…å±•ç¤ºå‰å‡ è¡Œ) ---
        function renderTable(hourlyData, selectedParams) {
            const thead = document.getElementById('table-head');
            const tbody = document.getElementById('table-body');
            
            // è¡¨å¤´
            let headerHTML = '<tr><th class="px-6 py-3">æ—¶é—´</th>';
            selectedParams.forEach(p => {
                headerHTML += `<th class="px-6 py-3">${p.label}</th>`;
            });
            headerHTML += '</tr>';
            thead.innerHTML = headerHTML;

            // è¡¨ä½“ (å–å‰5æ¡æ•°æ®ä½œä¸ºç¤ºä¾‹)
            let bodyHTML = '';
            for (let i = 0; i < 5; i++) {
                bodyHTML += '<tr class="bg-white border-b hover:bg-gray-50">';
                bodyHTML += `<td class="px-6 py-4 font-medium text-gray-900">${hourlyData.time[i].replace('T', ' ')}</td>`;
                selectedParams.forEach(p => {
                    bodyHTML += `<td class="px-6 py-4">${hourlyData[p.id][i]} ${p.unit}</td>`;
                });
                bodyHTML += '</tr>';
            }
            tbody.innerHTML = bodyHTML;
        }

        // --- 6. è¾…åŠ©åŠŸèƒ½ ---

        function toggleAll(checked) {
            const inputs = document.querySelectorAll('#checkbox-container input');
            inputs.forEach(input => input.checked = checked);
        }

        function setLoading(isLoading) {
            const btnText = document.getElementById('btn-text');
            const btnSpinner = document.getElementById('btn-spinner');
            if (isLoading) {
                btnText.innerText = "åŠ è½½ä¸­...";
                btnSpinner.classList.remove('hidden');
            } else {
                btnText.innerText = "ç”Ÿæˆå›¾è¡¨";
                btnSpinner.classList.add('hidden');
            }
        }
        
        function useCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    document.getElementById('input-lat').value = position.coords.latitude.toFixed(4);
                    document.getElementById('input-lon').value = position.coords.longitude.toFixed(4);
                    // è‡ªåŠ¨åˆ·æ–°
                    fetchData();
                }, () => {
                    alert("æ— æ³•è·å–æ‚¨çš„ä½ç½®ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥ã€‚");
                });
            } else {
                alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®åŠŸèƒ½ã€‚");
            }
        }
    </script>
</body>
</html>